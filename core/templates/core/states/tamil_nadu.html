{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tamil Nadu - South India Tourism</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="{% static 'core/css/style.css' %}">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&family=Poppins:wght@300;500&display=swap" rel="stylesheet">
  <!-- Load Google Maps JavaScript API -->
  <script>
    (g=>{var h,a,k,p="The Google Maps JavaScript API",c="google",l="importLibrary",q="__ib__",m=document,b=window;b=b[c]||(b[c]={});var d=b.maps||(b.maps={}),r=new Set,e=new URLSearchParams,u=()=>h||(h=new Promise(async(f,n)=>{await (a=m.createElement("script"));e.set("libraries",[...r]+"");for(k in g)e.set(k.replace(/[A-Z]/g,t=>"_"+t[0].toLowerCase()),g[k]);e.set("callback",c+".maps."+q);a.src=`https://maps.${c}apis.com/maps/api/js?`+e;d[q]=f;a.onerror=()=>h=n(Error(p+" could not load."));a.nonce=m.querySelector("script[nonce]")?.nonce||"";m.head.append(a)}));d[l]?console.warn(p+" only loads once. Ignoring:",g):d[l]=(f,...n)=>r.add(f)&&u().then(()=>d[l](f,...n))})({
      key: "AIzaSyD3WSnlZlux7vVPP2LQ7fZvg8O43J01mK8",
      v: "weekly",
      libraries: "places"  // Include Places library for future use (nearby search)
    });
  </script>
  <style>
    .hero-section {
      background: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url("{% static 'core/images/tamil_nadu.jpg' %}");
      background-size: cover;
      background-position: center;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      color: white;
    }
    .place-card img {
      height: 200px;
      object-fit: cover;
    }
    .map-modal .modal-dialog {
      max-width: 800px;
    }
    .map-container {
      height: 400px;
      width: 100%;
    }
    .place-card .map-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1;
    }
  </style>
  <!-- Add Font Awesome in the head section -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
</head>
<body>
  <!-- Messages Section -->
  {% if messages %}
    <div class="messages">
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-custom sticky-top">
    <div class="container-fluid">
      <a class="navbar-brand" href="{% url 'core:home' %}">South India Tourism</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link active" href="{% url 'core:home' %}">Home</a></li>
          <li class="nav-item"><a class="nav-link" href="{% url 'core:home' %}#category">Adventures</a></li>
          <li class="nav-item"><a class="nav-link" href="{% url 'core:home' %}#packages">Packages</a></li>
          <li class="nav-item"><a class="nav-link" href="{% url 'core:home' %}#contact">Contact</a></li>
          {% if user.is_authenticated %}
            <li class="nav-item"><a class="nav-link" href="{% url 'core:my_favorites' %}">My Favorites</a></li>
            <li class="nav-item"><a class="nav-link" href="{% url 'core:profile' %}">Profile</a></li>
            <li class="nav-item">
              <form action="{% url 'logout' %}" method="post" style="display: inline;">
                {% csrf_token %}
                <button type="submit" class="btn btn-light nav-btn">Logout</button>
              </form>
            </li>
          {% else %}
            <li class="nav-item">
              <a href="{% url 'login' %}" class="btn btn-light nav-btn">Login</a>
            </li>
            <li class="nav-item">
              <a href="{% url 'signup' %}" class="btn btn-light nav-btn">Sign Up</a>
            </li>
          {% endif %}
        </ul>
      </div>
    </div>
  </nav>

  <!-- Hero Section -->
  <section class="hero-section">
    <div class="hero-overlay">
      <h1 class="hero-title text-white animate__animated animate__fadeIn">Discover Tamil Nadu</h1>
      <p class="hero-subtitle text-white animate__animated animate__fadeIn animate__delay-1s">Experience the Land of Temples</p>
      {% if user.is_authenticated %}
        {% if state in user.favorite_states.all %}
          <form action="{% url 'core:remove_state_favorite' state.id %}" method="post" class="d-inline">
            {% csrf_token %}
            <button type="submit" class="btn btn-danger btn-sm mt-2">
              <i class="fas fa-heart"></i> Remove from Favorites
            </button>
          </form>
        {% else %}
          <form action="{% url 'core:add_state_favorite' state.id %}" method="post" class="d-inline">
            {% csrf_token %}
            <button type="submit" class="btn btn-outline-light btn-sm mt-2">
              <i class="far fa-heart"></i> Add to Favorites
            </button>
          </form>
        {% endif %}
      {% endif %}
      <a href="#booking" class="btn btn-primary btn-sm mt-2 animate__animated animate__fadeIn animate__delay-2s">Plan Your Trip</a>
    </div>
  </section>

  <!-- Secondary Navigation -->
  <nav class="secondary-nav sticky-top">
    <div class="container">
      <ul class="nav justify-content-center">
        <li class="nav-item"><a class="nav-link" href="#overview">Overview</a></li>
        <li class="nav-item"><a class="nav-link" href="#places">Places to Visit</a></li>
        <li class="nav-item"><a class="nav-link" href="#cuisine">Cuisine</a></li>
        <li class="nav-item"><a class="nav-link" href="#events">Events</a></li>
        <li class="nav-item"><a class="nav-link" href="#weather">Weather</a></li>
        <li class="nav-item"><a class="nav-link" href="#ugc">Traveler Stories</a></li>
        <li class="nav-item"><a class="nav-link" href="#safety">Safety Tips</a></li>
        <li class="nav-item"><a class="nav-link" href="#booking">Booking</a></li>
      </ul>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="main-content">
    <!-- State Details Section -->
    <section class="state-details py-6" id="overview">
      <div class="container">
        <ul class="nav nav-tabs state-tabs mb-4" id="stateTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <a class="nav-link active" id="overview-tab" data-bs-toggle="tab" href="#overview-tab-content" role="tab" aria-controls="overview-tab-content" aria-selected="true">Overview</a>
          </li>
          <li class="nav-item" role="presentation">
            <a class="nav-link" id="history-tab" data-bs-toggle="tab" href="#history" role="tab" aria-controls="history" aria-selected="false">History</a>
          </li>
          <li class="nav-item" role="presentation">
            <a class="nav-link" id="culture-tab" data-bs-toggle="tab" href="#culture" role="tab" aria-controls="culture" aria-selected="false">Culture</a>
          </li>
          <li class="nav-item" role="presentation">
            <a class="nav-link" id="climate-tab" data-bs-toggle="tab" href="#climate" role="tab" aria-controls="climate" aria-selected="false">Climate</a>
          </li>
          <li class="nav-item" role="presentation">
            <a class="nav-link" id="best-time-tab" data-bs-toggle="tab" href="#best-time" role="tab" aria-controls="best-time" aria-selected="false">Best Time to Visit</a>
          </li>
        </ul>

        <div class="tab-content" id="stateTabsContent">
          <div class="tab-pane fade show active" id="overview-tab-content" role="tabpanel" aria-labelledby="overview-tab">
            <h2 class="section-title">{{ state.description }}</h2>
            <p class="section-content">
              Tamil Nadu, located in the southernmost part of India, is known for its ancient temples, classical arts, and rich cultural heritage. The state is home to magnificent Dravidian temples, beautiful hill stations, and pristine beaches. From the bustling city of Chennai to the spiritual town of Madurai, Tamil Nadu offers a perfect blend of tradition and modernity.
            </p>
          </div>
          <div class="tab-pane fade" id="history" role="tabpanel" aria-labelledby="history-tab">
            <h2 class="section-title">History</h2>
            <p class="section-content">{{ state.history }}</p>
          </div>
          <div class="tab-pane fade" id="culture" role="tabpanel" aria-labelledby="culture-tab">
            <h2 class="section-title">Culture</h2>
            <p class="section-content">{{ state.culture }}</p>
            <h4 class="mt-4">Cultural Safety Tips</h4>
            <ul class="safety-tips-list">
              {% for tip in state.cultural_safety_tips %}
                <li>{{ tip }}</li>
              {% empty %}
                <li>No specific cultural safety tips available.</li>
              {% endfor %}
            </ul>
          </div>
          <div class="tab-pane fade" id="climate" role="tabpanel" aria-labelledby="climate-tab">
            <h2 class="section-title">Climate</h2>
            <p class="section-content">{{ state.climate }}</p>
          </div>
          <div class="tab-pane fade" id="best-time" role="tabpanel" aria-labelledby="best-time-tab">
            <h2 class="section-title">Best Time to Visit</h2>
            <p class="section-content">{{ state.best_time_to_visit }}</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Places to Visit -->
    <section class="places-section py-6 bg-light" id="places">
      <div class="container">
        <h2 class="section-title text-center mb-5">Places to Visit</h2>
        <!-- AI-Powered Recommendations -->
        <div class="mb-5">
          <h4 class="text-center">Recommended for You</h4>
          <div class="row" id="recommended-places">
            <div class="col-12 text-center">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <p>Loading personalized recommendations...</p>
            </div>
          </div>
        </div>

        <div class="mb-4 text-center">
          <label for="categoryFilter" class="form-label">Filter by Category:</label>
          <select id="categoryFilter" class="form-select w-auto d-inline-block mx-auto" onchange="location = this.value;">
            <option value="{% url 'core:state_detail' state.name|lower|slugify %}">All Categories</option>
            {% for category, label in categories %}
              <option value="{% url 'core:state_detail' state.name|lower|slugify %}?category={{ category }}" {% if selected_category == category %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- Places List -->
        <div class="row" id="places-list">
          {% for place_data in places_with_weather %}
            <div class="col-md-6 col-lg-4 mb-4">
              <div class="card h-100">
                {% if place_data.place.image %}
                  <img src="{{ place_data.place.image.url }}" class="card-img-top" alt="{{ place_data.place.name }}">
                {% endif %}
                <div class="card-body">
                  <h5 class="card-title">{{ place_data.place.name }}</h5>
                  <p class="card-text">{{ place_data.place.description }}</p>
                  
                  <!-- Weather Information -->
                  {% if place_data.weather %}
                    <div class="weather-info mb-3">
                      <h6>Current Weather</h6>
                      <p>Temperature: {{ place_data.weather.temperature }}°C</p>
                      <p>Condition: {{ place_data.weather.condition }}</p>
                    </div>
                  {% endif %}
                  
                  <!-- Map Container -->
                  <div class="map-container" id="map-{{ place_data.place.id }}" style="height: 300px;"></div>
                  
                  <!-- Action Buttons -->
                  <div class="mt-3">
                    {% if user.is_authenticated %}
                      <form method="post" action="{% url 'core:add_favorite' place_data.place.id %}" class="d-inline">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-outline-primary btn-sm">
                          <i class="fas fa-heart"></i> Add to Favorites
                        </button>
                      </form>
                    {% endif %}
                    <a href="#" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#reviewModal{{ place_data.place.id }}">
                      Write a Review
                    </a>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Review Modal -->
            <div class="modal fade" id="reviewModal{{ place_data.place.id }}" tabindex="-1">
              <div class="modal-dialog">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title">Write a Review for {{ place_data.place.name }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                  </div>
                  <div class="modal-body">
                    <form method="post" action="{% url 'core:add_review' place_data.place.id %}">
                      {% csrf_token %}
                      <div class="mb-3">
                        <label for="rating" class="form-label">Rating</label>
                        <select name="rating" id="rating" class="form-select" required>
                          <option value="5">5 Stars</option>
                          <option value="4">4 Stars</option>
                          <option value="3">3 Stars</option>
                          <option value="2">2 Stars</option>
                          <option value="1">1 Star</option>
                        </select>
                      </div>
                      <div class="mb-3">
                        <label for="comment" class="form-label">Comment</label>
                        <textarea name="comment" id="comment" class="form-control" rows="3" required></textarea>
                      </div>
                      <button type="submit" class="btn btn-primary">Submit Review</button>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          {% empty %}
            <div class="col-12 text-center">
              <p>No places found for this category.</p>
            </div>
          {% endfor %}
        </div>
      </div>
    </section>

    <!-- Add this section after the existing recommendations section -->
    <div class="container mt-5">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h3 class="mb-0">Gemini-Powered Recommendations</h3>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="user-place">Select Your Current Place:</label>
                            <select id="user-place" class="form-control">
                                {% for place_data in places_with_weather %}
                                    <option value="{{ place_data.place.name }}" 
                                            data-lat="{{ place_data.latitude }}" 
                                            data-lng="{{ place_data.longitude }}">
                                        {{ place_data.place.name }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="gemini-place-type">Preferred Place Type:</label>
                            <select id="gemini-place-type" class="form-control">
                                <option value="tourist_attraction">Tourist Attraction</option>
                                <option value="hindu_temple">Temple</option>
                                <option value="park">Hill Station/Park</option>
                                <option value="beach">Beach</option>
                                <option value="museum">Museum</option>
                                <option value="restaurant">Restaurant</option>
                                <option value="shopping_mall">Shopping</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="budget">Budget Preference:</label>
                            <select id="budget" class="form-control">
                                <option value="low">Low (Free or Minimal Cost)</option>
                                <option value="medium">Medium (Moderate Cost)</option>
                                <option value="high">High (Premium Experiences)</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="text-center mt-3">
                    <button class="btn btn-primary" onclick="fetchGeminiRecommendations()">Get Personalized Recommendations</button>
                </div>
                <div id="gemini-recommended-places" class="mt-4">
                    <!-- Gemini Recommendations will be displayed here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Local Cuisine and Dining Recommendations -->
    <section class="cuisine-section py-6" id="cuisine">
      <div class="container">
        <h2 class="section-title text-center mb-5">Local Cuisine and Dining Recommendations</h2>
        <div class="row">
          <div class="col-md-6 mb-4">
            <div class="card cuisine-card h-100">
              <div class="card-body">
                <h4>Iconic Dishes</h4>
                <p>Indulge in Tamil Nadu's culinary delights:</p>
                <ul>
                  {% for cuisine in state.cuisines.all %}
                    <li><strong>{{ cuisine.name }}:</strong> {{ cuisine.description }}</li>
                  {% empty %}
                    <li>No iconic dishes listed.</li>
                  {% endfor %}
                </ul>
              </div>
            </div>
          </div>
          <div class="col-md-6 mb-4">
            <div class="card cuisine-card h-100">
              <div class="card-body">
                <h4>Top Restaurants</h4>
                {% for restaurant in state.restaurants.all %}
                  <div class="restaurant-item mb-3">
                    <h6>{{ restaurant.name }}</h6>
                    <p><strong>Specialty:</strong> {{ restaurant.specialty }}</p>
                    <p><strong>Average Cost:</strong> ₹{{ restaurant.average_cost }} per person.</p>
                  </div>
                {% empty %}
                  <p>No top restaurants listed.</p>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Events and Festivals -->
    <section class="events-section py-6 bg-light" id="events">
      <div class="container">
        <h2 class="section-title text-center mb-5">Events and Festivals</h2>
        <div class="row">
          {% for event in state.events.all %}
            <div class="col-md-4 mb-4">
              <div class="card event-card h-100">
                <div class="card-body">
                  <h5>{{ event.name }}</h5>
                  <p><strong>Date:</strong> {{ event.date }}</p>
                  <p><strong>Location:</strong> {{ event.location }}</p>
                  <p>{{ event.description }}</p>
                </div>
              </div>
            </div>
          {% empty %}
            <div class="col-12 text-center">
              <p>No upcoming events or festivals listed.</p>
            </div>
          {% endfor %}
        </div>
      </div>
    </section>

    <!-- Weather and Real-Time Updates -->
    <section class="weather-section py-6" id="weather">
      <div class="container">
        <h2 class="section-title text-center mb-5">Current Weather in Chennai</h2>
        {% if weather_data %}
          <div class="row justify-content-center">
            <div class="col-md-6">
              <div class="card weather-card">
                <div class="card-body text-center">
                  <h3 class="card-title">{{ weather_data.city }}</h3>
                  <div class="weather-info">
                    <p class="temperature">{{ weather_data.temperature }}°C</p>
                    <p class="condition">{{ weather_data.condition }}</p>
                    <p class="humidity">Humidity: {{ weather_data.humidity }}%</p>
                  </div>
                  <div class="weather-suggestions mt-4">
                    <h4>Travel Suggestions</h4>
                    <ul class="list-unstyled">
                      {% for suggestion in weather_data.suggestions %}
                        <li><i class="fas fa-check-circle text-success"></i> {{ suggestion }}</li>
                      {% endfor %}
                    </ul>
                  </div>
                  <div class="weather-safety mt-4">
                    <h4>Safety Tips</h4>
                    <ul class="list-unstyled">
                      {% for tip in weather_data.safety_tips %}
                        <li><i class="fas fa-exclamation-triangle text-warning"></i> {{ tip }}</li>
                      {% endfor %}
                    </ul>
                  </div>
                </div>
              </div>
            </div>
          </div>
        {% else %}
          <div class="text-center">
            <p>Weather information is currently unavailable.</p>
          </div>
        {% endif %}
      </div>
    </section>

    <!-- User-Generated Content and Social Proof -->
    <section class="ugc-section py-6 bg-light" id="ugc">
      <div class="container">
        <h2 class="section-title text-center mb-5">Traveler Stories</h2>
        <div class="row">
          <div class="col-md-6 mb-4 mx-auto">
            <div class="card ugc-card h-100">
              <div class="card-body">
                <h4>User Reviews</h4>
                {% for review in state.reviews.all %}
                  <div class="review-item mb-3">
                    <p><strong>{{ review.user.username }}</strong> ({{ review.rating }}/5): {{ review.comment }}</p>
                    <small class="text-muted">Posted on {{ review.created_at|date:"F d, Y" }}</small>
                  </div>
                {% empty %}
                  <p>No reviews available. Be the first to share your experience!</p>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Travel Safety Tips -->
    <section class="safety-section py-6" id="safety">
      <div class="container">
        <h2 class="section-title text-center mb-5">Travel Safety Tips</h2>
        <div class="row">
          <div class="col-md-6 mb-4">
            <div class="card safety-card h-100">
              <div class="card-body">
                <h4>General Safety Tips</h4>
                <ul class="safety-tips-list">
                  <li>Be cautious of pickpockets in crowded areas like markets and temples.</li>
                  <li>Keep your belongings secure while visiting popular tourist spots.</li>
                  <li>Follow local customs and dress codes when visiting religious sites.</li>
                </ul>
              </div>
            </div>
          </div>
          <div class="col-md-6 mb-4">
            <div class="card safety-card h-100">
              <div class="card-body">
                <h4>Emergency Contacts</h4>
                <ul class="safety-tips-list">
                  <li><strong>Police:</strong> 100</li>
                  <li><strong>Tourist Helpline:</strong> 1800-425-31111</li>
                  <li><strong>Apollo Hospital (Chennai):</strong> +91-44-2829-0202</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Booking and Inquiry Options -->
    <section class="booking-section py-6 bg-light" id="booking">
      <div class="container">
        <h2 class="section-title text-center mb-5">Plan Your Trip</h2>
        <div class="row">
          <div class="col-md-6 mb-4">
            <div class="card booking-card h-100">
              <div class="card-body text-center">
                <h4>Book a Tour Package</h4>
                <a href="#" class="btn btn-primary">Explore Packages</a>
              </div>
            </div>
          </div>
          <div class="col-md-6 mb-4">
            <div class="card booking-card h-100">
              <div class="card-body">
                <h4>Custom Inquiry</h4>
                <form action="{% url 'core:submit_inquiry' state.id %}" method="post">
                  {% csrf_token %}
                  <div class="mb-3">
                    <input type="text" name="name" class="form-control" placeholder="Your Name" required>
                  </div>
                  <div class="mb-3">
                    <input type="email" name="email" class="form-control" placeholder="Your Email" required>
                  </div>
                  <div class="mb-3">
                    <textarea name="message" class="form-control" rows="3" placeholder="Tell us about your trip plans..." required></textarea>
                  </div>
                  <button type="submit" class="btn btn-primary btn-sm">Submit Inquiry</button>
                </form>
              </div>
            </div>
          </div>
        </div>
        <!-- Itinerary Suggestion -->
        <div class="mt-5">
          <h3 class="text-center">Suggested Itinerary</h3>
          <div class="row">
            {% for itinerary in state.itineraries.all %}
              <div class="col-md-4 mb-4">
                <div class="card itinerary-card h-100">
                  <div class="card-body">
                    <h5>Day {{ itinerary.day }}</h5>
                    <p>{{ itinerary.description }}</p>
                  </div>
                </div>
              </div>
            {% empty %}
              <div class="col-12 text-center">
                <p>No itinerary suggestions available.</p>
              </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- Footer -->
  <footer class="footer py-4">
    <div class="container text-center">
      <p class="credit">Created by <span>Team South India Tourism</span> | © 2025</p>
    </div>
  </footer>

  <!-- Back to Top Button -->
  <a href="#" class="back-to-top" aria-label="Back to Top">
    <i class="fas fa-chevron-up"></i>
  </a>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://unpkg.com/aos@next/dist/aos.js"></script>
  <script>
    // Navbar/Secondary Nav scroll effect for state pages
    window.addEventListener('scroll', function() {
      const navbar = document.querySelector('.navbar');
      const secondaryNav = document.querySelector('.secondary-nav');
      if (secondaryNav) {
        if (window.scrollY > 100) {
          navbar.style.display = 'none';
          secondaryNav.classList.add('active');
        } else {
          navbar.style.display = '';
          secondaryNav.classList.remove('active');
        }
      }
    });

    // Initialize AOS
    AOS.init({ duration: 1000, once: true });

    // Initialize maps for each place
    function initMaps() {
      {% for place_data in places_with_weather %}
      new google.maps.Map(document.getElementById('map-{{ place_data.place.id }}'), {
        center: { lat: {{ place_data.latitude }}, lng: {{ place_data.longitude }} },
        zoom: 15
      });
      {% endfor %}
    }

    // Load Google Maps API
    function loadGoogleMapsAPI() {
      const script = document.createElement('script');
      script.src = `https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_MAPS_API_KEY }}&callback=initMaps`;
      script.async = true;
      script.defer = true;
      document.head.appendChild(script);
    }

    // Load the API when the page loads
    window.onload = loadGoogleMapsAPI;

    // Define the Gemini endpoint URL using Django's URL template tag
    const geminiRecommendationsUrl = "{% url 'core:get_gemini_recommendations' %}";

    function showOnMap(lat, lng, title) {
        // Get the map container
        const mapContainer = document.getElementById("state-map");
        
        // Clear any existing map
        mapContainer.innerHTML = '';
        
        // Create a new map instance
        const map = new google.maps.Map(mapContainer, {
            center: { lat: parseFloat(lat), lng: parseFloat(lng) },
            zoom: 15,
            mapTypeControl: true,
            streetViewControl: true,
            fullscreenControl: true
        });

        // Add a marker for the selected place
        const marker = new google.maps.Marker({
            position: { lat: parseFloat(lat), lng: parseFloat(lng) },
            map: map,
            title: title,
            animation: google.maps.Animation.DROP
        });

        // Add an info window
        const infoWindow = new google.maps.InfoWindow({
            content: `<div><h5>${title}</h5></div>`
        });

        // Show info window on marker click
        marker.addListener("click", () => {
            infoWindow.open(map, marker);
        });

        // Open info window by default
        infoWindow.open(map, marker);
    }

    function fetchGeminiRecommendations() {
        const placeSelect = document.getElementById("user-place");
        const selectedOption = placeSelect.options[placeSelect.selectedIndex];
        const userPlace = selectedOption.value;
        const latitude = selectedOption.getAttribute('data-lat');
        const longitude = selectedOption.getAttribute('data-lng');
        const placeType = document.getElementById("gemini-place-type").value;
        const budget = document.getElementById("budget").value;

        if (!latitude || !longitude) {
            alert("Please select a valid place");
            return;
        }

        // Show loading state
        const geminiRecommendedPlacesDiv = document.getElementById("gemini-recommended-places");
        geminiRecommendedPlacesDiv.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"><span class="sr-only">Loading...</span></div></div>';

        // Construct the URL with query parameters
        const url = `${geminiRecommendationsUrl}?latitude=${latitude}&longitude=${longitude}&user_place=${encodeURIComponent(userPlace)}&place_type=${placeType}&budget=${budget}`;

        fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    geminiRecommendedPlacesDiv.innerHTML = `<div class="alert alert-danger">Error: ${data.error}</div>`;
                    return;
                }

                const places = data.gemini_recommended_places;
                const weatherData = data.weather_data;

                if (!places || places.length === 0) {
                    geminiRecommendedPlacesDiv.innerHTML = "<div class='alert alert-info'>No recommendations available at the moment.</div>";
                    return;
                }

                // Display weather information
                let html = `
                    <div class="weather-info mb-4">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title"><i class="fas fa-cloud-sun"></i> Current Weather</h5>
                                <div class="row">
                                    <div class="col-md-3">
                                        <p class="mb-0"><strong>Temperature:</strong> ${weatherData.temperature}°C</p>
                                    </div>
                                    <div class="col-md-3">
                                        <p class="mb-0"><strong>Weather:</strong> ${weatherData.weather}</p>
                                    </div>
                                    <div class="col-md-3">
                                        <p class="mb-0"><strong>Humidity:</strong> ${weatherData.humidity}%</p>
                                    </div>
                                    <div class="col-md-3">
                                        <p class="mb-0"><strong>Description:</strong> ${weatherData.description}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                `;

                places.forEach(place => {
                    const hasCoordinates = place.latitude && place.longitude;
                    html += `
                        <div class="col-md-6 mb-4">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h5 class="card-title">${place.name}</h5>
                                    <p class="card-text">
                                        ${place.rating ? `<span class="badge bg-primary">Rating: ${place.rating}</span><br>` : ''}
                                        ${hasCoordinates ? 
                                            `<small class="text-muted">Location: ${place.latitude}, ${place.longitude}</small><br>` : 
                                            '<small class="text-muted">Location: Not available</small><br>'
                                        }
                                        <em>${place.reasoning}</em>
                                    </p>
                                    ${hasCoordinates ? 
                                        `<button class="btn btn-sm btn-outline-primary" onclick="showOnMap(${place.latitude}, ${place.longitude}, '${place.name}')">
                                            Show on Map
                                        </button>` :
                                        `<button class="btn btn-sm btn-outline-secondary" disabled>
                                            Location Unavailable
                                        </button>`
                                    }
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += "</div>";
                geminiRecommendedPlacesDiv.innerHTML = html;
            })
            .catch(error => {
                console.error('Error:', error);
                geminiRecommendedPlacesDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
            });
    }
  </script>
  <script src="{% static 'core/js/scripts.js' %}"></script>
  <script src="{% static 'core/js/state.js' %}"></script>
</body>
</html>